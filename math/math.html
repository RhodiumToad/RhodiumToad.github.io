<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width" />
<title>MathJax scratchpad</title>
<style>
body {
  padding: 5px;
  overscroll-behavior-y: contain;
}
.mathInput {
  font-size: 150%;
  margin-top: 1ex;
  margin-bottom: 1ex;
}
input, textarea {
  border-width: 2px;
}
.ui-tab tbody tr > td:nth-of-type(odd) {
  text-align: right;
}
.ui-tab input {
  margin-right: 2em;
}
.ui-tab input[type='number'] {
  width: 6em;
}
input.mathSvgUpdate {
  margin-right: 2em;
  margin-bottom: 8ex;
}
#MathSvgImg1, .imgBorder {
  border: 2px solid;
  border-color: black;
}
#MathSvgImg1 {
  padding: 10px 5px;
}
#MathImg1 {

}
details {
  margin-top: 10px;
}
details > summary {
  font-size: 120%;
  width: 30em;
  padding: 2px 6px;
  border: 2px solid;
  margin-bottom: 5px;
}
@media (prefers-color-scheme: dark) {
  html, textarea {
    background-color: black;
    color: white;
  }
  #MathSvgImg1, .imgBorder {
    border-color: white;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
MathJax = {
  loader: {load: ['ui/safe']},
  tex: {
    processEnvironments: false,
    tags: 'ams',
    macros: {
      N: "\\\\[5pt]",
      NN: "\\\\[8pt]",
      NNN: "\\\\[12pt]",
      d: ["\\mathrm{d}{#1}", 1],
      hq: "\\Space{0.5em}{1ex}{0ex}",
    },
  },
  options: {
    safeOptions: {
      allow: {
        URLs: 'none',
        classes: 'safe',
        cssIDs: 'safe',
        styles: 'safe',
      },
    },
  },
};

MyMath = {
  prefs: {
    theme: "device",
    colors: {
      dark: {
        fg: "#fff",
        bg: "#000",
      },
      light: {
        fg: "#000",
        bg: "#fff",
      },
    },
    canvas: {
      scale: 2,
      device_scale: true,
      target: 600,
      cropleft: 0,
      padding: 5,
      border: 0,
      transparent: false,
    },
    tex: {
      display: true,
      em: 16,
      ex: 8,
      scale: 1,
      containerWidth: 800,
    },
  },
  themes: {
    dark: ()=>{ return "dark"; },
    light: ()=>{ return "light"; },
    device: ()=>{ return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; },
  },
  cur_theme: null,
  prefs_init: {
    types: {
      checkbox: (o,n)=>{ return MyMath.prefs.canvas[n] ? ["on"] : []; },
    },
    names: {
      theme: (o,n)=>{ return MyMath.prefs.theme; },
    },
    default: (o,n)=>{ return MyMath.prefs.canvas[n]; },
  },
  prefs_update: {
    types: {
      number: (o,n,v)=>{ MyMath.prefs.canvas[n] = 1*v; },
      checkbox: (o,n,v)=>{ MyMath.prefs.canvas[n] = o.checked; },
      "select-one": (o,n,v)=>{ MyMath.prefs.canvas[n] = 1*v; },
    },
    names: {
      theme: (o,n,v)=>{ MyMath.prefs.theme = v; },
    },
  },
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg-full.js">
</script>
<script>
toB64 = (function(){
  let e = new TextEncoder();
  return function(s){
    const b = e.encode(s);
    return btoa(Array.from(b, (x)=>(String.fromCodePoint(x))).join(""));
  };
})();
(function($){
  const svg_ns = "http://www.w3.org/2000/svg";

  DoStatus = (function(){
    let t = "";
    return function(m){
      if (m==="") {
        t = m;
      } else {
        t += m;
        t += "\n";
        $("#MathSvgImgErr1").text(t);
      }
    };
  })();

  // conversion takes two steps because the svg image render may be async,
  // and we can't render the canvas until the image is ready.

  // convert mathjax output to a svg data url
  let mjx2str = function(mjx,metrics,tgtwf,diags) {
    let svg = mjx.getElementsByTagName("svg")[0];
    let defs = svg.getElementsByTagName("defs")[0];
    if (!defs) {
      defs = document.createElementNS(svg_ns, "defs");
      svg.prepend(defs);
    }
    let css = document.createElementNS(svg_ns, "style");
    let txt = `:root { color: ${MyMath.cur_theme.fg}; }\n`;
    css.appendChild(document.createTextNode(txt));
    defs.prepend(css);
    let styles = MathJax.svgStylesheet();
    defs.prepend(styles);
    if (svg.getAttribute("width")=="100%") {
      let tgtw = tgtwf();
      svg.setAttribute("width", `${tgtw / metrics.ex}ex`);
    }
    let s = svg.outerHTML;
    if (diags) { diags(s,styles.outerHTML); }
    return "data:image/svg+xml;base64," + toB64(s);
  };

  // convert an image to a PNG data url
  let img2png = function(img,tgtw,sizef) {
    let w = tgtw ? tgtw : img.naturalWidth;
    let h = img.naturalHeight;
    let cl = MyMath.prefs.canvas.cropleft;
    let c = document.createElement("canvas");
    let b = MyMath.prefs.canvas.padding;
    let bw = 0;
    let sc = MyMath.prefs.canvas.scale * 
               (MyMath.prefs.canvas.device_scale
                ? window.devicePixelRatio
                : 1);
    if (MyMath.prefs.canvas.border > 0) {
      bw = MyMath.prefs.canvas.border;
      b += bw;
    }
    c.width = (w-cl)*sc+2*sc*b;
    c.height = h*sc+2*sc*b;
    let ctx = c.getContext("2d");
    if (bw > 0) {
      ctx.strokeStyle = MyMath.cur_theme.fg;
      ctx.lineWidth = bw;
      ctx.lineCap = "square";
      ctx.lineJoin = "miter";
      ctx.strokeRect(bw/2,bw/2,c.width-bw,c.height-bw);
    }
    if (!MyMath.prefs.canvas.transparent) {
      ctx.fillStyle = MyMath.cur_theme.bg;
      ctx.fillRect(bw,bw,c.width-2*bw,c.height-2*bw);
    }
    ctx.fillStyle = MyMath.cur_theme.fg;
    ctx.drawImage(img,cl,0,w-cl,h,
                      b*sc,b*sc,(w-cl)*sc,h*sc);
    sizef(w-cl+b+b,h+b+b,sc);
    DoStatus(`loaded ${w}x${h} ${img.width}x${img.height} ${sc} ${MyMath.prefs.canvas.device_scale} ${window.devicePixelRatio} ${bw} ${tgtw ? tgtw : 0}`);
    return c.toDataURL();
  };

  $(function($){
    $(".mathCfg").each((i,e)=>{
      let f = MyMath.prefs_init.names[e.name] ||
              MyMath.prefs_init.types[e.type] ||
              MyMath.prefs_init.default;
      $(e).val(f(e,e.name));
    });
    $("html").on("change", ".mathCfg", function(e){
      let f = MyMath.prefs_update.names[this.name] ||
              MyMath.prefs_update.types[this.type];
      f(this,this.name,this.value);
    });
  });

  $(function($){
    $("input.mathSvgUpdate").click(function(e){
      e.stopPropagation();
      DoStatus("");
      let theme = MyMath.themes[MyMath.prefs.theme]();
      MyMath.cur_theme = MyMath.prefs.colors[theme];
      let tgtw = false;
      let m = $("#MathInput1").val();
      MathJax.texReset();
      let tgt = $("#MathSvgImg1");
      let pngtgt = $("#MathImg1");
      pngtgt.toggleClass("imgBorder",
                         !(MyMath.prefs.canvas.border > 0));
      let metrics = MathJax.getMetricsFor(tgt.get(0),true);
      MathJax.tex2svgPromise(m, metrics)
        .then((mjx)=>{
          let img = new Image();
          let s = mjx2str(mjx,metrics,
                          ()=>{ tgtw = MyMath.prefs.canvas.target;
                                img.width = tgtw;
                                return tgtw; },
                          (svg,css)=>{ $("#MathSvg1").val(svg);
                                       $("#MathCss1").val(css); });
          return new Promise((resolve,reject)=>{
            img.addEventListener("error",
              function(e){ reject(e.message); },
              { once: true });
            img.addEventListener("load",
              function(e){ resolve(img); },
              { once: true });
            tgt.empty().prepend(img);
            img.src = s;
          });
        })
        .then((img)=>{
          let u2 = img2png(img,tgtw,
                           (w,h,sc)=>{
                             pngtgt.css("width",w).css("height",h);
                           });
          pngtgt.attr("src", u2);
          DoStatus(`${JSON.stringify(metrics)}`);
        })
        .catch((e)=>{ DoStatus(e.message); });
      return true;
    });
  });
})(jQuery.noConflict());
</script>
</head>
<body>
<div id="MathSvgImg1"></div>
<div><textarea cols=60 rows=20 class="mathInput" id="MathInput1"></textarea></div>
<div style="display: flex">
<div><input type="button" class="mathSvgUpdate" value="Update" /></div>
<div><img id="MathImg1" class="imgBorder" /></div>
</div>
<details open>
<summary>Configuration</summary>
<div>
<table class="ui-tab">
 <tbody>
  <tr>
   <td>Scale:</td>
   <td><input type="number" class="mathCfg" name="scale" value="1" min="0.1" max="20" /></td>
   <td>Respect device ratio:</td>
   <td><input type="checkbox" class="mathCfg" name="device_scale"></td>
  </tr>
  <tr>
   <td>Target width:</td>
   <td><input type="number" class="mathCfg" name="target" value="100" min="50" max="4000" /></td>
   <td>Transparent:</td>
   <td><input type="checkbox" class="mathCfg" name="transparent" checked></td>
  </tr>
  <tr>
   <td>Crop left:</td>
   <td><input type="number" class="mathCfg" name="cropleft" value="0" min="0" max="4000" /></td>
   <td>Theme:</td>
   <td>
    <select class="mathCfg" name="theme">
     <option value="device">Device theme</option>
     <option value="dark">Dark theme</option>
     <option value="light">Light theme</option>
    </select>
   </td>
  </tr>
  <tr>
   <td>Padding:</td>
   <td><input type="number" class="mathCfg" name="padding" value="5" min="0" max="50" / ></td>
   <td>Border:</td>
   <td>
    <select class="mathCfg" name="border">
     <option value="0">none</option>
     <option value="1">1px solid</option>
     <option value="2">2px solid</option>
     <option value="3">3px solid</option>
     <option value="4">4px solid</option>
     <option value="5">5px solid</option>
    </select>
   </td>
  </tr>
 </tbody>
</table>
</div>
</details>
<details>
<summary>Status</summary>
 <pre style="font-size: 120%; max-width: 30em; overflow: scroll; white-space: pre-wrap" id="MathSvgImgErr1">(no error 1)</pre>
</details>
<details>
<summary>SVG content</summary>
<textarea cols=60 rows=15 id="MathSvg1"></textarea>
</details>
<details>
<summary>CSS content</summary>
<textarea cols=60 rows=15 id="MathCss1"></textarea>
</details>
</body>
</html>
